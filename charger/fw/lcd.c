#include "common.h"

#define ILI9341_RESET				0x01
#define ILI9341_SLEEP_OUT			0x11
#define ILI9341_GAMMA				0x26
#define ILI9341_DISPLAY_OFF			0x28
#define ILI9341_DISPLAY_ON			0x29
#define ILI9341_COLUMN_ADDR			0x2A
#define ILI9341_PAGE_ADDR			0x2B
#define ILI9341_GRAM				0x2C
#define ILI9341_MAC			        0x36
#define ILI9341_VSCRSADD            0x37
#define ILI9341_PIXEL_FORMAT        0x3A
#define ILI9341_WDB			    	0x51
#define ILI9341_WCD				    0x53
#define ILI9341_RGB_INTERFACE       0xB0
#define ILI9341_FRC				    0xB1         
#define ILI9341_BPC				    0xB5
#define ILI9341_DFC				    0xB6         
#define ILI9341_ETMOD               0xB7
#define ILI9341_POWER1				0xC0
#define ILI9341_POWER2				0xC1
#define ILI9341_VCOM1				0xC5         
#define ILI9341_VCOM2				0xC7         
#define ILI9341_POWERA				0xCB
#define ILI9341_POWERB				0xCF         
#define ILI9341_PGAMMA				0xE0         
#define ILI9341_NGAMMA				0xE1         
#define ILI9341_DTCA				0xE8         
#define ILI9341_DTCB				0xEA
#define ILI9341_POWER_SEQ			0xED
#define ILI9341_3GAMMA_EN			0xF2         
#define ILI9341_INTERFACE			0xF6
#define ILI9341_PRC				    0xF7

#define C0(opc)                     ILI9341_##opc, 0
#define C1(opc, p1)                 ILI9341_##opc, 1, p1
#define C2(opc, p1, p2)             ILI9341_##opc, 2, p1, p2
#define C3(opc, p1, p2, p3)         ILI9341_##opc, 3, p1, p2, p3
#define C4(opc, p1, p2, p3, p4)     ILI9341_##opc, 4, p1, p2, p3, p4
#define C5(opc, p1, p2, p3, p4, p5) ILI9341_##opc, 5, p1, p2, p3, p4, p5
#define CW(opc)                     ILI9341_##opc, 0x80

static __code uint8_t init_script[] = {
    CW(RESET),
    C0(DISPLAY_OFF),
    C5(POWERA, 0x39, 0x2C, 0x00, 0x34, 0x02),
    C3(POWERB, 0x00, 0xC1, 0x30),
    C4(POWER_SEQ, 0x64, 0x03, 0x12, 0x81),
    C3(DTCA, 0x85, 0x00, 0x78),
    C2(DTCB, 0x00, 0x00),
    C1(PRC, 0x20),
    C1(POWER1, 0x23),
    C1(POWER2, 0x10),
    C2(VCOM1, 0x3E, 0x28),
    C1(VCOM2, 0x86),
    C1(MAC, 0xE8),
    C1(PIXEL_FORMAT, 0x55),
    C2(FRC, 0x00, 0x18),
    C1(GAMMA, 0x01),
    C1(ETMOD, 0x07),
    C4(DFC, 0x0A, 0x82, 0x27, 0x00),
    CW(SLEEP_OUT),
    CW(DISPLAY_ON),
0};

#define W do {while(!ISPI); ISPI=0;} while(0)

#define SPI_SEND(value) do {LCD_CS_n=0; SPIDAT = (value); W; LCD_CS_n=1;} while(0)
#define SPI_SEND_CMD(value) do {LCD_DC=0; SPI_SEND(value); LCD_DC=1;} while(0)

void lcd_init(void)
{
    __code uint8_t* script = init_script;
    uint8_t tmp;

    LCD_Reset_n = 1; // Turn off reset on LCD
    delay_ms(5);

    while(*script!=0)
    {
        SPI_SEND_CMD(*script++);
        tmp = *script++;
        if (tmp&0x80) {delay_ms(150); continue;}
        while(tmp--) SPI_SEND(*script++);
    }
    lcd_box(0,0,320,240,2);
    P2_6 = 1;
}

#define S(value, wait) do {LCD_DC=0; LCD_CS_n=0; SPIDAT = (value); wait; LCD_DC=1;} while(0)
#define D(v) do {SPIDAT = (uint8_t)(v); W;} while(0)
#define W_NR do {while(!ISPI);} while(0)

static void lcd_box_start(uint16_t x, uint8_t y, uint16_t dx, uint8_t dy)
{
    dx += x-1;
    dy += y-1;
    S(ILI9341_COLUMN_ADDR, W); D(x>>8); D(x); D(dx>>8); D(dx); LCD_CS_n=1;
    S(ILI9341_PAGE_ADDR, W); D(0); D(y); D(0); D(dy); LCD_CS_n=1;
    S(ILI9341_GRAM, W_NR);
}

#undef D
#define D(v) do {W; SPIDAT = (uint8_t)(v);} while(0)

void lcd_box(uint16_t x, uint8_t y, uint16_t dx, uint8_t dy, uint8_t color)
{
    lcd_box_start(x, y, dx, dy);

    uint8_t xx = (uint8_t)(dx>>1);
    uint8_t locx;
    uint8_t c1 = colors_map[color];
    uint8_t c2 = colors_map[(uint8_t)(color+1)];

    if (!xx) // dx is 1
    {
        do {D(c1); D(c2);} while(--dy);
    }
    else if (1 & (uint8_t)dx)
    {
        do {
            locx = xx;
            do {D(c1); D(c2); D(c1); D(c2);} while(--locx);
            D(c1); D(c2);
        } while(--dy);
    }
    else
    {
        do {
            locx = xx;
            do {D(c1); D(c2); D(c1); D(c2);} while(--locx);
        } while(--dy);
    }
    W; LCD_CS_n=1;
}

static void lcd_logo_imp(void)
{
    __code uint8_t* logo_script = start_logo_data;
    uint8_t row;
    for(row=0; row<240; ++row)
    {
        __code uint8_t* rainbow = logo_rainbow + logo_sin[row];
        uint8_t total_data = *logo_script++;
        uint8_t ff = 2;
        while(total_data--)
        {
            uint8_t count = *logo_script++;
            while(count--)
            {
                D(rainbow[ff]); D(rainbow[ff+1]);
                rainbow += 4;
            }
            ff ^= 2;
        }
    }
}

void lcd_logo(void)
{
    lcd_box_start(0, 0, 320, 240);
    lcd_logo_imp();
    W; LCD_CS_n=1;
}

static __code uint8_t font[] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x18,0x3C,0x3C,0x3C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00,
    0x00,0x66,0x66,0x66,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x6C,0x6C,0xFE,0x6C,0x6C,0x6C,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00,
    0x18,0x18,0x7C,0xC6,0xC2,0xC0,0x7C,0x06,0x86,0xC6,0x7C,0x18,0x18,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0xC2,0xC6,0x0C,0x18,0x30,0x60,0xC6,0x86,0x00,0x00,0x00,0x00,
    0x00,0x00,0x38,0x6C,0x6C,0x38,0x76,0xDC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00,
    0x00,0x30,0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x0C,0x18,0x30,0x30,0x30,0x30,0x30,0x30,0x18,0x0C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x30,0x18,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x18,0x30,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x02,0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0xC6,0xCE,0xD6,0xD6,0xE6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x18,0x38,0x78,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0x06,0x0C,0x18,0x30,0x60,0xC0,0xC6,0xFE,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0x06,0x06,0x3C,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x0C,0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00,
    0x00,0x00,0xFE,0xC0,0xC0,0xC0,0xFC,0x0E,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x38,0x60,0xC0,0xC0,0xFC,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0xFE,0xC6,0x06,0x06,0x0C,0x18,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7E,0x06,0x06,0x06,0x0C,0x78,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x06,0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x60,0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0xC6,0x0C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x7C,0xC6,0xC6,0xDE,0xDE,0xDE,0xDC,0xC0,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00,
    0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x66,0x66,0x66,0x66,0xFC,0x00,0x00,0x00,0x00,
    0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xC0,0xC0,0xC2,0x66,0x3C,0x00,0x00,0x00,0x00,
    0x00,0x00,0xF8,0x6C,0x66,0x66,0x66,0x66,0x66,0x66,0x6C,0xF8,0x00,0x00,0x00,0x00,
    0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00,
    0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00,
    0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xDE,0xC6,0xC6,0x66,0x3A,0x00,0x00,0x00,0x00,
    0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00,
    0x00,0x00,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0xCC,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00,
    0x00,0x00,0xE6,0x66,0x6C,0x6C,0x78,0x78,0x6C,0x66,0x66,0xE6,0x00,0x00,0x00,0x00,
    0x00,0x00,0xF0,0x60,0x60,0x60,0x60,0x60,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00,
    0x00,0x00,0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00,
    0x00,0x00,0xC6,0xE6,0xF6,0xFE,0xDE,0xCE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00,
    0x00,0x00,0x38,0x6C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x00,0x00,0x00,0x00,
    0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xD6,0xDE,0x7C,0x0C,0x0E,0x00,0x00,
    0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x6C,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0xC6,0x60,0x38,0x0C,0x06,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7E,0x7E,0x5A,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,
    0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x10,0x00,0x00,0x00,0x00,
    0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xD6,0xD6,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00,
    0x00,0x00,0xC6,0xC6,0x6C,0x6C,0x38,0x38,0x6C,0x6C,0xC6,0xC6,0x00,0x00,0x00,0x00,
    0x00,0x00,0x66,0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,
    0x00,0x00,0xFE,0xC6,0x86,0x0C,0x18,0x30,0x60,0xC2,0xC6,0xFE,0x00,0x00,0x00,0x00,
    0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x80,0xC0,0xE0,0x70,0x38,0x1C,0x0E,0x06,0x02,0x00,0x00,0x00,0x00,
    0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00,
    0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,
    0x30,0x30,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x78,0x0C,0x7C,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00,
    0x00,0x00,0xE0,0x60,0x60,0x78,0x6C,0x66,0x66,0x66,0x66,0xDC,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC0,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x1C,0x0C,0x0C,0x3C,0x6C,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xFE,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x38,0x6C,0x64,0x60,0xF0,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0xCC,0x78,0x00,
    0x00,0x00,0xE0,0x60,0x60,0x6C,0x76,0x66,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00,
    0x00,0x00,0x18,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x06,0x06,0x00,0x0E,0x06,0x06,0x06,0x06,0x06,0x06,0x66,0x66,0x3C,0x00,
    0x00,0x00,0xE0,0x60,0x60,0x66,0x6C,0x78,0x78,0x6C,0x66,0xE6,0x00,0x00,0x00,0x00,
    0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xEC,0xFE,0xD6,0xD6,0xD6,0xD6,0xD6,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00,
    0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0x0C,0x1E,0x00,
    0x00,0x00,0x00,0x00,0x00,0xDC,0x76,0x62,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0x60,0x38,0x0C,0xC6,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x10,0x30,0x30,0xFC,0x30,0x30,0x30,0x30,0x36,0x1C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,0xD6,0xD6,0xFE,0x6C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xC6,0x6C,0x38,0x38,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7E,0x06,0x0C,0xF8,0x00,
    0x00,0x00,0x00,0x00,0x00,0xFE,0xCC,0x18,0x30,0x60,0xC6,0xFE,0x00,0x00,0x00,0x00,
    0x00,0x00,0x0E,0x18,0x18,0x18,0x70,0x18,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00,
    0x00,0x00,0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00,
    0x00,0x00,0x70,0x18,0x18,0x18,0x0E,0x18,0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00,
    0x00,0x00,0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xC6,0xFE,0x00,0x00,0x00,0x00,0x00
};

void lcd_text(const char* text, uint16_t x, uint8_t y, uint8_t color)
{
    uint8_t txt_len = strlen(text);
    lcd_box_start(x,y,txt_len<<3,16);

    uint8_t scan_line;
    const char* t;
    uint8_t fc1 = colors_map[color];
    uint8_t fc2 = colors_map[(uint8_t)(color+1)];
    uint8_t bc1 = colors_map[(uint8_t)(color+2)];
    uint8_t bc2 = colors_map[(uint8_t)(color+3)];

    for(scan_line=0; scan_line!=16; ++scan_line)
    {
        for(t=text;; ++t)
        {
            uint8_t sym = *t;
            if (!sym) break;
            uint8_t bits = font[(sym-' ')*16+scan_line];
            uint8_t cnt=8;
            do {
                if (bits&0x80) {D(fc1); D(fc2);}
                else {D(bc1); D(bc2);}
                bits <<= 1;
            } while (--cnt);
        }
    }
    W; LCD_CS_n=1;
}

void lcd_text2(const char* text, uint16_t x, uint8_t y, uint8_t color)
{
    uint8_t txt_len = strlen(text);
    lcd_box_start(x,y,txt_len<<4,32);

    uint8_t scan_line;
    const char* t;
    uint8_t fc1 = colors_map[color];
    uint8_t fc2 = colors_map[(uint8_t)(color+1)];
    uint8_t bc1 = colors_map[(uint8_t)(color+2)];
    uint8_t bc2 = colors_map[(uint8_t)(color+3)];

    for(scan_line=0; scan_line!=32; ++scan_line)
    {
        for(t=text;; ++t)
        {
            uint8_t sym = *t;
            if (!sym) break;
            uint8_t bits = font[(sym-' ')*16+(scan_line>>1)];
            uint8_t cnt=8;
            do {
                if (bits&0x80) {D(fc1); D(fc2); D(fc1); D(fc2);}
                else {D(bc1); D(bc2); D(bc1); D(bc2);}
                bits <<= 1;
            } while (--cnt);
        }
    }
    W; LCD_CS_n=1;
}

#undef S
#undef W
#undef W_NR
#undef D

enum ScriptCode {
    SC_End,
    SC_Text,
    SC_Box = 0x20,
    SC_Rect
};

void lcd_draw_script(__code uint8_t *script)
{
    uint8_t code, y, dy, color;
    ByteWord x, dx;
    __code char* p;
#define S (*script++)
    EA = 0;
    while( (code=S) !=0 )
    {
        x.l=S; y=S; color=S; x.h=0; dx.h=0;
        if (code & 0x80) x.h=1;
        if (code & 0x20) {dx.l=S; dy=S; if (code & 0x40) dx.h=1;}
        switch((uint8_t)(code&0x3F))
        {
            case SC_Box:  lcd_box(x.w,        y,      dx.w, dy, color); break;
            case SC_Rect: lcd_box(x.w,        y,      1,    dy, color); 
                          lcd_box(x.w+dx.w-1, y,      1,    dy, color); 
                          lcd_box(x.w,        y,      dx.w,  1, color); 
                          lcd_box(x.w,        y+dy-1, dx.w,  1, color); break;
            case SC_Text: p=script; script+=strlen(p)+1; if (code&0x40) lcd_text2(p, x.w, y, color); else lcd_text(p, x.w, y, color); break;
            default: EA=1; return;
        }
    }
    EA = 1;
#undef S
}

